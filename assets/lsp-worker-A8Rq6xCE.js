const h=new TextEncoder,v=new TextDecoder;let o=null,g=null;const p=new Map;let w=null;async function b(){if(o)return;const t=await(await fetch(new URL("/wren-lsp/assets/wren-playground-9f_MvQCp.wasm",import.meta.url))).arrayBuffer(),r=(await import("./index-DLpwg0kr.js")).WASI,s=[{fd_write:()=>{throw new Error("stdio write is not supported")},fd_read:()=>{throw new Error("stdio read is not supported")}},{fd_write:()=>{throw new Error("stdio write is not supported")},fd_read:()=>{throw new Error("stdio read is not supported")}},{fd_write:()=>{throw new Error("stdio write is not supported")},fd_read:()=>{throw new Error("stdio read is not supported")}}];g=new r(["wren-playground.wasm"],[],s,{debug:!1});const{instance:n}=await WebAssembly.instantiate(t,{wasi_snapshot_preview1:g.wasiImport,env:{wren_lsp_host_resolve:E}});g.inst=n,o=n.exports,o.createServer()}function M(e){const t=e.lastIndexOf("/");return t<0?e:e.slice(0,t+1)}function U(e,t){if(t.startsWith("file://"))return t;if(t.startsWith("/"))return`file://${t}`;const r=M(e);return new URL(t,r).toString()}async function W(){w=null;const e="file:///playground/wren-lsp.json",t=p.get(e);if(!t)return;let r=null;try{r=JSON.parse(t)}catch{return}const n=(Array.isArray(r?.resolvers)?r.resolvers:[]).find(i=>i&&i.type==="host"),f=typeof n?.script=="string"?n.script:"";if(!f)return;const a=U(e,f),c=p.get(a);if(c)try{const i=new Blob([c],{type:"text/javascript"}),u=URL.createObjectURL(i),l=await import(`${u}#${Date.now()}`);if(URL.revokeObjectURL(u),typeof l.preloadDomeModules=="function")try{await l.preloadDomeModules()}catch(y){console.warn("[playground] preloadDomeModules failed",y)}typeof l.resolveHostImport=="function"&&(w=l.resolveHostImport)}catch(i){console.warn("[playground] failed loading resolver script",i)}}async function R(e){!e||e.type!=="setVirtualFile"||typeof e.uri!="string"||typeof e.content!="string"||(p.set(e.uri,e.content),(e.uri.includes("wren-lsp.json")||e.uri.includes("resolver.js"))&&await W())}function _(e,t){return new Uint8Array(o.memory.buffer,e,t)}function m(e,t){return v.decode(_(e,t))}function j(e,t){if(!t.startsWith("./")&&!t.startsWith("../"))return null;let r=t;r.endsWith(".wren")||(r+=".wren");const s=new URL(r,e).href,n=p.get(s);return n!==void 0?{canonical_id:s,uri:s,source:n,kind:"virtual"}:null}function E(e,t,r,s,n,f,a,c){if(!o)return 0;const i=m(e,t),u=m(r,s),l=j(i,u)||(typeof w=="function"?w(i,u):null);if(!l)return 0;const y=JSON.stringify(l),d=h.encode(y);return d.length<=c&&_(a,d.length).set(d),d.length}function L(e){const t=h.encode(e),r=o.allocMessage(t.length);new Uint8Array(o.memory.buffer).set(t,r),o.call();const n=o.outputMessageCount(),f=[];for(let a=0;a<n;a++){const c=o.outputMessagePtr(a),i=o.outputMessageLen(a),u=new Uint8Array(o.memory.buffer).slice(c,c+i);f.push(v.decode(u))}return f}self.addEventListener("message",async e=>{const{token:t,payload:r,control:s}=e.data;try{if(s){await R(s),postMessage({token:t,outputs:[]});return}await b();const n=L(r);postMessage({token:t,outputs:n})}catch(n){postMessage({token:t,error:n instanceof Error?n.message:String(n)})}});
